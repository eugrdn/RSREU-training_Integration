# Лабораторная работа №3

## Интеграция пользовательского интерфейса с базой данных

В данной лабораторной работе необходимо объединить знания полученные на предыдущих лабах, для выполнения интеграции между клиентом, сервером и БД.

Далее пошагово описан процесс настройки и взаимодействия отдельных модулей, а т.ж приведен список заданий по вариантам в конце документа.

### Шаг :one: -- Подключение MongoDB

Для того, чтобы обеспечить взаимную работу нашей БД с сервером необходимо установить специальный npm-пакет `mongodb`, который является официальным драйвером MongoDB для Node.js и предоставляет высокоуровневое API поверх mongodb-ядра. Скорее всего он у вас уже установлен. Для этого загляните в файл package.json (объект "dependencies"), если же нет, введите в консоли следующую команду

``` js
  npm install --save mongodb
```

Теперь необходимо подключить установленный пакет к проекту. Для того, чтобы использовать объект нашей БД в любом месте проекта вынесем логику взаимодействия с ним в отдельный модуль: создадим папку `./db` в корне проекта, а т.ж файл `index.js`.

Импортируем нужную нам библиотеку с помощью подхода CommonJS. В данном случае нас интересует объект MongoClient, который позволит установить соединение с БД, а затем при ее успешном установлении получить объект БД.

``` js
const MongoClient = require('mongodb').MongoClient;
let _db = null;

module.exports = {
  connect(url) {
    return MongoClient.connect(url)
      .then(db => (_db = db))
      .catch(err => Promise.reject(err));
  },
};
```
В данном подходе мы используем _Promise_, чтобы получить результат подключения к БД. Перенесите этот код в свой модуль.

Но зачем нам переменная _db? В ней будет храниться объект базы данных. Сейчас он не очень полезен, т.к используется только в текущем модуле. Целесообразно будет написать метод, который бы отдавал нам этот объект. 

#### Задание 1.1 
Напишите метод `#getInstance`, который будет отдавать объект БД, если тот имеется, в противном случае, выбрасываем ошибку, что соединение прервано.

#### Задание 1.2* 
Напишите метод `#getCollection`, который будет принимать название коллекции БД, и возвращать объект этой коллекции соответственно, в противном случае -- ошибка о не существующей коллекции.

Шаг 1 почти завершен, осталось выполнить само подключение, используя наш модуль db. Перейдем корневой в файл "index.js", подключим наш модуль, а т.ж зададим **URL** нашей БД в константе.

```js
const MongoDB = require('./db/index');
const MONGO_URL = 'mongodb://localhost:27017/library';
```

Далее используя написанный ранее метод #connect установим соединение с БД, если все успешно в следующем .then мы можем использовать серверную часть, в противном случае завершаем программу.

```js
MongoDB.connect(MONGO_URL)
  .then(() => {
    console.log(`Connected succsessfully!`);
    require('./server');
  })
  .catch(err => console.log(`An error with connection to db ${err}!`));
```

### Шаг :two: -- Создание сервиса библиотеки (Library service)

В предыдущих лабораторных работах вами были созданы основные пути для доступа к API (./api/...). Сейчас они  предоставляют фиктивные данные. Наша задача -- создать модуль, который будет иметь доступ к объекту БД и вытаскивать из нее необходимые данные, согласно запросам с клиента.

Создадим папку `./services`, и файл `library.service.js`.
Импортируем объект БД из './db/index.js' с помощью метода #getInstance. 

Для удобства можно вынести объект коллекции в отдельную переменную: 
```js
const bookCol = db.collection('books');
``` 

Далее на примере запроса получения всех книг - **GET /api/books** напишем метод, который будем использовать в API: 

```js
module.exports = {
  getBooks() {
    return bookCol.find({}).toArray();
  },
};

```

Синтаксис mongodb очень похож на mongo-shell, используемый вами на предыдущей лабе. Однако, вы могли заметить метод ".toArray()". Дело в том, что метод find возвращает не данные, а объект cursor - указатель на результирующий набор данных, полученных с помощью запроса. Но нам нужны документы, а не указатель. Для этого и используется метод #toArray.

Подробнее про курсор можно прочитать [здесь](https://docs.mongodb.com/manual/reference/method/js-cursor/), а про метод #toArray [здесь](https://docs.mongodb.com/manual/reference/method/cursor.toArray/index.html).

Далее импортируем наш сервис в файл с API и используем его по-назначению:

```js
router
  .get('/books', (req, res) => {
      service.getAllBooks()
        .then(data => res.send(data))
        .catch(err => res.send(err));
  })
```
Драйвер mongodb позволяет использовать 2 вида управления асинхронными операциями:
* `callback`, передаваемый в используемую функцию
* возвращая `Promise` из используемой функции

В данном случае мы используем _Promise_, который так же можно сцеплять (chain) удобно использовать как показано здесь. После чего вызываем метод #send объекта response, и отправляем данные на клиент.

#### Задание 2.1. Написать функцию выборки данных сервиса library для следующих API:
* вариант 1,4 

## // TODO:

- [ ] написать про params
- [ ] несколько коллекций
- [ ] придумать задания по вариантам
- [ ] еще подробнее ?

